Index: rdma-core/ib2roce/ib2roce.c
===================================================================
--- rdma-core.orig/ib2roce/ib2roce.c
+++ rdma-core/ib2roce/ib2roce.c
@@ -893,21 +893,23 @@ static struct buf *buffers;
 
 static struct buf *nextbuffer;	/* Pointer to next available RDMA buffer */
 
-static void __free_buffer(struct buf *buf)
+static void free_buffer(struct buf *buf)
 {
 #ifdef DEBUG
 	memset(buf->raw, 0, DATA_SIZE);
 #endif
 	buf->free = true;
-	buf->next = nextbuffer;
-	nextbuffer = buf;
-}
 
-static void free_buffer(struct buf *buf)
-{
-	lock();
-	__free_buffer(buf);
-	unlock();
+	if (multithreaded) {
+		do {
+			buf->next = nextbuffer;
+
+		} while (!atomic_compare_exchange_weak(&nextbuffer, &buf->next, buf));
+
+	} else {
+		buf->next = nextbuffer;
+		nextbuffer = buf;
+	}
 }
 
 static void get_buf(struct buf *buf)
@@ -989,19 +991,34 @@ static void init_buf(void)
 		free_buffer(&buffers[i-1]);
 }
 
+static bool buf_cmpxchg(struct buf **x, struct buf *y, struct buf *z)
+{
+	if (multithreaded) {
+		return atomic_compare_exchange_weak(x, &y, z);
+
+	} else {
+		if (*x == y) {
+			*x = z;
+			return true;
+		}
+		return false;
+	}
+}
+
 static struct buf *alloc_buffer(struct rdma_channel *c)
 {
-	struct buf *buf;
+	struct buf *buf, *next;
 
-	lock();
-	buf = nextbuffer;
+	do {
+		buf = nextbuffer;
+		if (!buf)
+			return NULL;
 
-	if (buf) {
-		nextbuffer = buf->next;
-		buf->free = false;
-	}
+		next = buf->next;
+	} while (!buf_cmpxchg(&nextbuffer, buf, next));
+
+	buf->free = false;
 	buf->c = c;
-	unlock();
 
 #ifdef DEBUG
 	buf->next = NULL;
